<!doctype html>
<html>
        <head>
                <title>Socket.IO chat</title>
                <style>
                        #show_messages { height: 700px; }
                        #show_messages li { padding: 5px 10px; }
                        #show_messages li:nth-child(odd) { background: #eee; }
                        #meessage_box { height: auto; width:700px; float: left;}
                        #chat_content { float:left; border: 1px #000 solid;}
                        #content { display: none; }
                        .error { color: red;}
                        .whisper { color: green;}
                        .whisper_from_me { color: gray;}
                </style>
                <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
                <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
        </head>
<body>
        <div id="nick" >
                <p>暱稱</p>
                <p id="nick_error" ></p>
                <form action="" id="send_nickname">
                        <input type="text" id="nick_name" name="nick_name">
                        <input type="submit"/>
                </form>
        </div>
        <div id="content">
                <div id="room">
                        <p>聊天室</p>
                        <div id="rooms"></div>
                </div>

                <div id="chat_content">
                        <div id="message_box" >
                                <div id="show_messages"></div>
                                <form action="">
                                        <input id="m" autocomplete="off" /><button>Send</button>
                                </form>
                        </div>
                </div>
                <div id="users"></div>
        </div>
        <script>
                var socket      = io();
                var nick_form   = $('#send_nickname');
                var nick_error  = $('#nick_error');
                var users       = $('#users');
                var nick_name   = $('#nick_name');

                /**
                 *      更換聊天室
                 */
                function switch_room(room)
                {
                        socket.emit('switch_room', room);
                }

                /**
                 *      登入暱稱
                 */
                nick_form.submit(function(e){
                        e.preventDefault();
                        if ( nick_name.val().length > 0 )
                        {
                                // 加入新的人
                                socket.emit('new user', nick_name.val(), function(data){
                                        if (data)
                                        {
                                              $('#nick').hide();
                                              $('#content').show();
                                        }
                                        else
                                        {
                                                nick_error.html('已有相同名稱，請重試一次');
                                        }
                                });
                        }
                        else
                        {
                                nick_error.html('請輸入暱稱');
                        }
                        nick_name.val('');
                });

                /**
                 * 顯示聊天室有幾間
                 */
                socket.on('update_rooms', function(){

                        $('#rooms').empty();

                        $.each(rooms, function(key, value){
                                if ( value == current_room )
                                {
                                        $('#rooms').append('<div>' + value + '</div>');
                                }
                                else
                                {
                                        $('#rooms').append('<div><a href="#" onclick="switch_room(\''+value+'\')">' + value + '</a></div>');
                                }
                        });
                });

                /**
                 *      顯示使用者名稱
                 */
                socket.on('usernames', function(data){
                        var html = '';

                        for (var i = 0; i < data.length; i++) {
                                html += data[i] + '<br/>'
                        };

                        users.html(html);
                });

                /**
                 *      訊息交換
                 */
                $('form').submit(function(){
                        socket.emit('chat message', $('#m').val(), function(data){
                                // error msg
                                $('#show_messages').append( '<span class="error">' +  data + '</span><br/>');
                        });
                        $('#m').val('');
                        return false;
                });

                // 大眾訊息
                socket.on('chat message', function(msg){
                        $('#show_messages').append( '<span class="msg"><b>' + msg.nick_name + ': </b>' + msg.msg + '</span><br/>');
                });

                // 私人訊息
                socket.on('whisper', function(msg){
                        $('#show_messages').append( '<span class="whisper"><b>' + msg.nick_name + ': </b>' + msg.msg + '</span><br/>');
                });

                // 私人訊息
                socket.on('whisper_from_me', function(msg){
                        $('#show_messages').append( '<span class="whisper_from_me"><b>' + msg.nick_name + ': </b>' + msg.msg + '</span><br/>');
                });

                // 系統訊息
                socket.on('system', function(msg){
                        $('#show_messages').append( '<span class="error"><b>' + msg.nick_name + ': </b>' + msg.msg + '</span><br/>');
                });
        </script>

</body>
</html>